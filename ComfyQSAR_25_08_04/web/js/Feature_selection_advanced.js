import { app } from "../../../scripts/app.js";

// ComfyUI ÌëúÏ§Ä ÏúÑÏ†Ø Ïà®ÍπÄ ÌÉÄÏûÖ
const HIDDEN_TYPE = "hiddenWidget";

// ÏõêÎ≥∏ ÏúÑÏ†Ø ÏÜçÏÑ± Ï†ÄÏû•
const origProps = {};

// MethodÎ≥Ñ ÌååÎùºÎØ∏ÌÑ∞ Îß§Ìïë (Ïã§Ï†ú Python ÌååÏùºÍ≥º ÏùºÏπò)
function getMethodParameters(method) {
    const parameterMappings = {
        "Lasso": ["alpha", "max_iter"],
        "RandomForest": ["n_estimators", "max_depth", "min_samples_split", "criterion", "n_iterations"],
        "DecisionTree": ["max_depth", "min_samples_split", "criterion", "n_iterations"],
        "XGBoost": ["n_estimators", "max_depth", "learning_rate"],
        "LightGBM": ["n_estimators", "max_depth", "learning_rate"],
        "RFE": ["base_model_for_selection", "n_features"],
        "SelectFromModel": ["base_model_for_selection", "threshold"]
    };
    return parameterMappings[method] || [];
}

// advancedÍ∞Ä falseÏùº Îïå Ïà®Í∏∏ Í≥µÌÜµ ÏúÑÏ†ØÎì§
function getAdvancedOnlyWidgets() {
    return [
        // Î™®Îì† methodÎ≥Ñ ÌååÎùºÎØ∏ÌÑ∞Îì§
        "alpha", "max_iter", "n_estimators", "max_depth", "min_samples_split", 
        "criterion", "learning_rate", "n_iterations", "base_model_for_selection", 
        "n_features", "threshold"
    ];
}

// ÏúÑÏ†Ø ÌÜ†Í∏Ä Ìï®Ïàò (ComfyUI ÌëúÏ§Ä Î∞©Ïãù)
function toggleWidget(node, widget, show = false, nodeKey = "") {
    if (!widget) {
        console.warn(`[Calculation Advanced] toggleWidget called with null widget`);
        return;
    }
    
    console.log(`[Calculation Advanced] üîÑ Toggling widget "${widget.name}" to ${show ? 'SHOW' : 'HIDE'}`);
    console.log(`[Calculation Advanced] Current widget type: ${widget.type}, computeSize: ${typeof widget.computeSize}`);
    
    const propKey = `${nodeKey}_${widget.name}`;
    
    // ÏõêÎ≥∏ ÏÜçÏÑ± Ï†ÄÏû• (Ìïú Î≤àÎßå)
    if (!origProps[propKey]) {
        origProps[propKey] = { 
            origType: widget.type, 
            origComputeSize: widget.computeSize,
            origComputedHeight: widget.computedHeight || 0,
            origDisabled: widget.disabled || false,
            origDisplay: widget.options?.display || "number"
        };
        console.log(`[Calculation Advanced] üíæ Saved original props for ${widget.name}: type=${widget.type}, display=${widget.options?.display || 'none'}`);
    }
    
    const props = origProps[propKey];
    
    if (show) {
        // ÏúÑÏ†Ø ÌëúÏãú
        widget.type = props.origType;
        widget.computeSize = props.origComputeSize;
        widget.computedHeight = props.origComputedHeight;
        // ÏõêÎ≥∏ disabled ÏÉÅÌÉú Î≥µÏõê
        widget.disabled = props.origDisabled;
        // ÏõêÎ≥∏ display ÏÜçÏÑ± Î≥µÏõê
        if (widget.options && props.origDisplay) {
            widget.options.display = props.origDisplay;
        }
        // ÏúÑÏ†Ø ÌëúÏãú ÏÜçÏÑ± Î≥µÏõê
        widget.visible = true;
        widget.hidden = false;
        console.log(`[Calculation Advanced] ‚úÖ Shown: ${widget.name} (restored type: ${props.origType}, disabled: ${widget.disabled}, display: ${widget.options?.display || 'none'})`);
    } else {
        // ÏúÑÏ†Ø Ïà®ÍπÄ - slider ÏúÑÏ†ØÎèÑ ÏôÑÏ†ÑÌûà Ïà®ÍπÄ
        widget.type = HIDDEN_TYPE;
        widget.computeSize = () => [0, -4];
        widget.computedHeight = 0;
        // Ï∂îÍ∞ÄÎ°ú ÏúÑÏ†ØÏùÑ ÏôÑÏ†ÑÌûà ÎπÑÌôúÏÑ±Ìôî
        widget.disabled = true;
        // slider ÏúÑÏ†ØÏùò Í≤ΩÏö∞ Ï∂îÍ∞Ä Ï≤òÎ¶¨
        if (widget.options && widget.options.display === "slider") {
            widget.options.display = "number"; // sliderÎ•º numberÎ°ú Î≥ÄÍ≤Ω
        }
        // Ï∂îÍ∞ÄÎ°ú ÏúÑÏ†ØÏùÑ ÏôÑÏ†ÑÌûà Ïà®Í∏∞Í∏∞ ÏúÑÌïú Í∞ïÏ†ú Ï≤òÎ¶¨
        widget.visible = false;
        widget.hidden = true;
        console.log(`[Calculation Advanced] ‚ùå Hidden: ${widget.name} (type changed to: ${HIDDEN_TYPE}, disabled: ${widget.disabled})`);
    }
}

// ÎÖ∏Îìú ÌÅ¨Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
function updateNodeSize(node) {
    setTimeout(() => {
        const newSize = node.computeSize();
        node.setSize(newSize);
        app.canvas.setDirty(true, true);
        console.log(`[Calculation Advanced] Node resized to: ${newSize}`);
    }, 10);
}

// ComfyUI ÌôïÏû• Îì±Î°ù
app.registerExtension({
    name: "QSAR.CalculationAdvanced",
    
    async beforeRegisterNodeDef(nodeType, nodeData, app) {
        // Feature Selection Í¥ÄÎ†® ÎÖ∏ÎìúÎì§ ÌôïÏù∏
        const isFeatureSelectionNode = nodeData.name === "Feature_Selection_Regression" || 
                                       nodeData.name === "Feature_Selection_Classification" ||
                                       nodeData.name.includes("Feature_Selection");
        
        if (isFeatureSelectionNode) {
            console.log(`[Calculation Advanced] Registering dynamic control for: ${nodeData.name}`);
            
            const originalNodeCreated = nodeType.prototype.onNodeCreated;
            
            nodeType.prototype.onNodeCreated = function() {
                originalNodeCreated?.apply(this, arguments);
                
                console.log(`[Calculation Advanced] Node created: ${this.title || nodeData.name}`);
                
                // ÎÖ∏ÎìúÎ≥Ñ Í≥†Ïú† ÌÇ§
                const nodeKey = `${nodeData.name}_${this.id || Date.now()}`;
                this.nodeKey = nodeKey;
                
                // Î™®Îì† Ï°∞Í±¥Î∂Ä ÌååÎùºÎØ∏ÌÑ∞ Î™©Î°ù (Ïã§Ï†ú Python ÌååÏùºÍ≥º ÏùºÏπò)
                const allConditionalParams = [
                    "n_features", "threshold", "alpha", "max_iter",
                    "n_estimators", "max_depth", "min_samples_split", 
                    "criterion", "learning_rate", "n_iterations",
                    "base_model_for_selection"
                ];
                
                // Ï†úÏñ¥ ÏúÑÏ†ØÎì§ Ï∞æÍ∏∞ (method ÎòêÎäî model Îì±)
                const methodWidget = this.widgets.find(w => w.name === "method") ||
                                   this.widgets.find(w => w.name === "model") ||
                                   this.widgets.find(w => w.name === "base_model");
                const advancedWidget = this.widgets.find(w => w.name === "advanced");
                
                if (!methodWidget) {
                    console.warn(`[Calculation Advanced] No method/model widget found in ${nodeData.name}`);
                    return;
                }
                
                if (!advancedWidget) {
                    console.warn(`[Calculation Advanced] Advanced widget not found - advanced mode control disabled`);
                }
                
                console.log(`[Calculation Advanced] Control widgets found - method: ${methodWidget.value}, advanced: ${advancedWidget?.value || 'N/A'}`);
                console.log(`[Calculation Advanced] Available widgets: ${this.widgets.map(w => w.name).join(', ')}`);
                console.log(`[Calculation Advanced] Conditional widgets: ${allConditionalParams.join(', ')}`);
                
                // Î™®Îì† Ï°∞Í±¥Î∂Ä ÏúÑÏ†ØÏùò ÏõêÎ≥∏ ÏÜçÏÑ± Ï†ÄÏû•
                allConditionalParams.forEach(paramName => {
                    const widget = this.widgets.find(w => w.name === paramName);
                    if (widget) {
                        const propKey = `${nodeKey}_${paramName}`;
                        origProps[propKey] = { 
                            origType: widget.type, 
                            origComputeSize: widget.computeSize,
                            origComputedHeight: widget.computedHeight || 0,
                            origDisabled: widget.disabled || false,
                            origDisplay: widget.options?.display || "number"
                        };
                        console.log(`[Calculation Advanced] Registered widget: ${paramName} (type: ${widget.type})`);
                    } else {
                        console.warn(`[Calculation Advanced] Widget not found: ${paramName}`);
                    }
                });
                
                // ÏúÑÏ†Ø Í∞ÄÏãúÏÑ± ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò (Ïù¥Ï§ë Ï°∞Í±¥Î∂Ä)
                const updateParameterVisibility = (selectedMethod, isAdvanced) => {
                    console.log(`[Calculation Advanced] üîÑ Updating visibility - method: ${selectedMethod}, advanced: ${isAdvanced}`);
                    
                    const activeParams = getMethodParameters(selectedMethod);
                    const advancedOnlyWidgets = getAdvancedOnlyWidgets();
                    
                    console.log(`[Calculation Advanced] Active params for ${selectedMethod}:`, activeParams);
                    
                    let changedCount = 0;
                    allConditionalParams.forEach(paramName => {
                        const widget = this.widgets.find(w => w.name === paramName);
                        if (widget) {
                            // Ïù¥Ï§ë Ï°∞Í±¥: advancedÍ∞Ä trueÏù¥Í≥† Ìï¥Îãπ methodÏóê ÌïÑÏöîÌïú ÌååÎùºÎØ∏ÌÑ∞
                            const isMethodParam = activeParams.includes(paramName);
                            const isAdvancedParam = advancedOnlyWidgets.includes(paramName);
                            const shouldShow = isAdvanced && isMethodParam;
                            
                            console.log(`[Calculation Advanced] üîß Processing widget: ${paramName} (type: ${widget.type}, display: ${widget.options?.display || 'none'})`);
                            toggleWidget(this, widget, shouldShow, nodeKey);
                            changedCount++;
                        }
                    });
                    
                    if (changedCount > 0) {
                        updateNodeSize(this);
                    }
                    
                    console.log(`[Calculation Advanced] ‚úÖ Updated ${changedCount} widgets for method: ${selectedMethod}, advanced: ${isAdvanced}`);
                };
                
                // method Í∞í Î≥ÄÍ≤Ω Í∞êÏßÄ (Property descriptor Î∞©Ïãù)
                const methodDesc = Object.getOwnPropertyDescriptor(methodWidget, "value") || {};
                let methodValue = methodWidget.value;
                
                Object.defineProperty(methodWidget, "value", {
                    get() {
                        return methodDesc.get ? methodDesc.get.call(methodWidget) : methodValue;
                    },
                    set(newVal) {
                        console.log(`[Calculation Advanced] üîÄ Method changed from "${methodValue}" to "${newVal}"`);
                        
                        if (methodDesc.set) methodDesc.set.call(methodWidget, newVal);
                        else methodValue = newVal;
                        
                        // ÌååÎùºÎØ∏ÌÑ∞ Í∞ÄÏãúÏÑ± ÏóÖÎç∞Ïù¥Ìä∏
                        updateParameterVisibility(newVal, advancedWidget?.value || false);
                    }
                });
                
                // advanced Í∞í Î≥ÄÍ≤Ω Í∞êÏßÄ (ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå)
                if (advancedWidget) {
                    const advancedDesc = Object.getOwnPropertyDescriptor(advancedWidget, "value") || {};
                    let advancedValue = advancedWidget.value;
                    
                    Object.defineProperty(advancedWidget, "value", {
                        get() {
                            return advancedDesc.get ? advancedDesc.get.call(advancedWidget) : advancedValue;
                        },
                        set(newVal) {
                            console.log(`[Calculation Advanced] üîÄ Advanced changed from ${advancedValue} to: ${newVal}`);
                            
                            if (advancedDesc.set) advancedDesc.set.call(advancedWidget, newVal);
                            else advancedValue = newVal;
                            
                            // ÌååÎùºÎØ∏ÌÑ∞ Í∞ÄÏãúÏÑ± ÏóÖÎç∞Ïù¥Ìä∏
                            updateParameterVisibility(methodWidget.value, newVal);
                        }
                    });
                }
                
                // Ï¥àÍ∏∞ ÏÉÅÌÉú ÏÑ§Ï†ï
                console.log(`[Calculation Advanced] üöÄ Setting initial state...`);
                updateParameterVisibility(methodWidget.value || "Lasso", advancedWidget?.value || false);
            };
            
            // ÎÖ∏Îìú Ï†úÍ±∞ Ïãú Ï†ïÎ¶¨
            const originalOnRemoved = nodeType.prototype.onRemoved;
            nodeType.prototype.onRemoved = function() {
                console.log(`[Calculation Advanced] üóëÔ∏è Cleaning up node: ${this.nodeKey}`);
                
                // Ïù¥ ÎÖ∏ÎìúÏùò ÏõêÎ≥∏ ÏÜçÏÑ±Îì§ Ï†ïÎ¶¨
                if (this.nodeKey) {
                    Object.keys(origProps).forEach(key => {
                        if (key.startsWith(this.nodeKey)) {
                            delete origProps[key];
                        }
                    });
                }
                
                originalOnRemoved?.apply(this, arguments);
            };
        }
    }
});

console.log("üéØ QSAR Calculation Advanced Extension Loaded (Enhanced Version)");
