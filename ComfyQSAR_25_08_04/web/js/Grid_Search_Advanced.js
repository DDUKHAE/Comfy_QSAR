import { app } from "../../../scripts/app.js";

// ComfyUI ÌëúÏ§Ä ÏúÑÏ†Ø Ïà®ÍπÄ ÌÉÄÏûÖ
const HIDDEN_TYPE = "hiddenWidget";

// ÏõêÎ≥∏ ÏúÑÏ†Ø ÏÜçÏÑ± Ï†ÄÏû•
const origProps = {};

// ÏúÑÏ†Ø ÌÜ†Í∏Ä Ìï®Ïàò (ComfyUI ÌëúÏ§Ä Î∞©Ïãù)
function toggleWidget(node, widget, show = false, nodeKey = "") {
    if (!widget) return;
    
    const propKey = `${nodeKey}_${widget.name}`;
    
    // ÏõêÎ≥∏ ÏÜçÏÑ± Ï†ÄÏû• (Ìïú Î≤àÎßå)
    if (!origProps[propKey]) {
        origProps[propKey] = { 
            origType: widget.type, 
            origComputeSize: widget.computeSize,
            origComputedHeight: widget.computedHeight || 0
        };
    }
    
    const props = origProps[propKey];
    
    if (show) {
        // ÏúÑÏ†Ø ÌëúÏãú
        widget.type = props.origType;
        widget.computeSize = props.origComputeSize;
        widget.computedHeight = props.origComputedHeight;
        console.log(`[Grid Search] ‚úÖ Shown: ${widget.name}`);
    } else {
        // ÏúÑÏ†Ø Ïà®ÍπÄ
        widget.type = HIDDEN_TYPE;
        widget.computeSize = () => [0, -4];
        widget.computedHeight = 0;
        console.log(`[Grid Search] ‚ùå Hidden: ${widget.name}`);
    }
}

// ÎÖ∏Îìú ÌÅ¨Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
function updateNodeSize(node) {
    setTimeout(() => {
        const newSize = node.computeSize();
        node.setSize(newSize);
        app.canvas.setDirty(true, true);
        console.log(`[Grid Search] Node resized to: ${newSize}`);
    }, 10);
}

// ÎÖ∏Îìú ÌÉÄÏûÖ Í∞êÏßÄ
function isGridSearchNode(nodeData) {
    const targetTypes = [
        "Hyperparameter_Grid_Search_Regression",
        "Hyperparameter_Grid_Search_Classification",
        "Grid_search_hyperparameter"
    ];
    return targetTypes.some(type => nodeData.name.includes(type)) || 
           nodeData.name.includes("Grid_Search") ||
           nodeData.name.includes("Hyperparameter");
}

// Í≥µÌÜµ ÏúÑÏ†Ø Î™©Î°ù (advancedÍ∞Ä trueÏùº ÎïåÎßå ÌëúÏãú)
function getCommonWidgets() {
    return [
        'test_size', 'num_cores', 'cv_splits', 'verbose', 'random_state', 'target_column'
    ];
}

// ÏïåÍ≥†Î¶¨Ï¶òÎ≥Ñ ÏúÑÏ†Ø Îß§Ìïë
function getAlgorithmWidgets(algorithm) {
    const algorithmWidgets = {
        "xgboost": ['n_estimators', 'learning_rate', 'max_depth', 'subsample', 'reg_alpha', 'reg_lambda'],
        "lightgbm": ['n_estimators', 'learning_rate', 'max_depth', 'num_leaves', 'reg_alpha', 'reg_lambda'],
        "random_forest": ['n_estimators', 'max_depth', 'min_samples_split', 'min_samples_leaf'],
        "decision_tree": ['max_depth', 'min_samples_split', 'min_samples_leaf', 'criterion'],
        "svm": ['C', 'kernel', 'gamma', 'epsilon'],
        "ridge": ['alpha'],
        "lasso": ['alpha'],
        "elasticnet": ['alpha', 'l1_ratio']
        // linear regressionÏùÄ ÌäπÎ≥ÑÌïú ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏóÜÏùå
    };
    return algorithmWidgets[algorithm] || [];
}

// Î™®Îì† Ï°∞Í±¥Î∂Ä ÏúÑÏ†Ø Î™©Î°ù
function getAllConditionalWidgets() {
    const commonWidgets = getCommonWidgets();
    const allAlgorithmWidgets = [
        ...getAlgorithmWidgets("xgboost"),
        ...getAlgorithmWidgets("lightgbm"),
        ...getAlgorithmWidgets("random_forest"),
        ...getAlgorithmWidgets("decision_tree"),
        ...getAlgorithmWidgets("svm"),
        ...getAlgorithmWidgets("ridge"),
        ...getAlgorithmWidgets("lasso"),
        ...getAlgorithmWidgets("elasticnet")
    ];
    
    // Ï§ëÎ≥µ Ï†úÍ±∞
    return [...new Set([...commonWidgets, ...allAlgorithmWidgets])];
}

// ComfyUI ÌôïÏû• Îì±Î°ù
app.registerExtension({
    name: "QSAR.GridSearchAdvanced",
    
    async beforeRegisterNodeDef(nodeType, nodeData, app) {
        if (isGridSearchNode(nodeData)) {
            console.log(`[Grid Search] Registering advanced control for: ${nodeData.name}`);
            
            const originalNodeCreated = nodeType.prototype.onNodeCreated;
            
            nodeType.prototype.onNodeCreated = function() {
                originalNodeCreated?.apply(this, arguments);
                
                console.log(`[Grid Search] Node created: ${this.title || nodeData.name}`);
                
                // ÎÖ∏ÎìúÎ≥Ñ Í≥†Ïú† ÌÇ§
                const nodeKey = `${nodeData.name}_${this.id || Date.now()}`;
                this.nodeKey = nodeKey;
                
                // Î™®Îì† Ï°∞Í±¥Î∂Ä ÏúÑÏ†Ø Î™©Î°ù
                const allConditionalWidgets = getAllConditionalWidgets();
                
                // Ï†úÏñ¥ ÏúÑÏ†ØÎì§ Ï∞æÍ∏∞
                const advancedWidget = this.widgets.find(w => w.name === "advanced");
                const algorithmWidget = this.widgets.find(w => w.name === "algorithm");
                
                if (!advancedWidget) {
                    console.log(`[Grid Search] Advanced widget not found`);
                    return;
                }
                
                if (!algorithmWidget) {
                    console.log(`[Grid Search] Algorithm widget not found`);
                    return;
                }
                
                console.log(`[Grid Search] Control widgets found - advanced: ${advancedWidget.value}, algorithm: ${algorithmWidget.value}`);
                console.log(`[Grid Search] Available widgets: ${this.widgets.map(w => w.name).join(', ')}`);
                console.log(`[Grid Search] Conditional widgets: ${allConditionalWidgets.join(', ')}`);
                
                // Î™®Îì† Ï°∞Í±¥Î∂Ä ÏúÑÏ†ØÏùò ÏõêÎ≥∏ ÏÜçÏÑ± Ï†ÄÏû•
                allConditionalWidgets.forEach(widgetName => {
                    const widget = this.widgets.find(w => w.name === widgetName);
                    if (widget) {
                        const propKey = `${nodeKey}_${widgetName}`;
                        origProps[propKey] = { 
                            origType: widget.type, 
                            origComputeSize: widget.computeSize,
                            origComputedHeight: widget.computedHeight || 0
                        };
                        console.log(`[Grid Search] Registered widget: ${widgetName} (type: ${widget.type})`);
                    } else {
                        console.warn(`[Grid Search] Widget not found: ${widgetName}`);
                    }
                });
                
                // ÏúÑÏ†Ø Í∞ÄÏãúÏÑ± ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
                const updateWidgetVisibility = (isAdvanced, selectedAlgorithm) => {
                    console.log(`[Grid Search] üîÑ Updating visibility - advanced: ${isAdvanced}, algorithm: ${selectedAlgorithm}`);
                    
                    let changedCount = 0;
                    
                    // 1. Í≥µÌÜµ ÏúÑÏ†ØÎì§ (advancedÍ∞Ä trueÏùº ÎïåÎßå ÌëúÏãú)
                    const commonWidgets = getCommonWidgets();
                    commonWidgets.forEach(widgetName => {
                        const widget = this.widgets.find(w => w.name === widgetName);
                        if (widget) {
                            toggleWidget(this, widget, isAdvanced, nodeKey);
                            changedCount++;
                        }
                    });
                    
                    // 2. ÏïåÍ≥†Î¶¨Ï¶òÎ≥Ñ ÏúÑÏ†ØÎì§ (advancedÍ∞Ä trueÏù¥Í≥† Ìï¥Îãπ ÏïåÍ≥†Î¶¨Ï¶òÏù¥ ÏÑ†ÌÉùÎêú Í≤ΩÏö∞Îßå ÌëúÏãú)
                    const allAlgorithms = ["xgboost", "lightgbm", "random_forest", "decision_tree", "svm", "ridge", "lasso", "elasticnet"];
                    
                    allAlgorithms.forEach(algorithm => {
                        const algorithmWidgets = getAlgorithmWidgets(algorithm);
                        const shouldShow = isAdvanced && selectedAlgorithm === algorithm;
                        
                        algorithmWidgets.forEach(widgetName => {
                            const widget = this.widgets.find(w => w.name === widgetName);
                            if (widget) {
                                toggleWidget(this, widget, shouldShow, nodeKey);
                                changedCount++;
                            }
                        });
                    });
                    
                    if (changedCount > 0) {
                        updateNodeSize(this);
                    }
                    
                    console.log(`[Grid Search] ‚úÖ Updated ${changedCount} widgets for advanced: ${isAdvanced}, algorithm: ${selectedAlgorithm}`);
                };
                
                // advanced Í∞í Î≥ÄÍ≤Ω Í∞êÏßÄ (Property descriptor Î∞©Ïãù)
                const advancedDesc = Object.getOwnPropertyDescriptor(advancedWidget, "value") || {};
                let advancedValue = advancedWidget.value;
                
                Object.defineProperty(advancedWidget, "value", {
                    get() {
                        return advancedDesc.get ? advancedDesc.get.call(advancedWidget) : advancedValue;
                    },
                    set(newVal) {
                        console.log(`[Grid Search] üîÄ Advanced changed from ${advancedValue} to: ${newVal}`);
                        
                        if (advancedDesc.set) advancedDesc.set.call(advancedWidget, newVal);
                        else advancedValue = newVal;
                        
                        // ÏúÑÏ†Ø Í∞ÄÏãúÏÑ± ÏóÖÎç∞Ïù¥Ìä∏
                        updateWidgetVisibility(newVal, algorithmWidget.value);
                    }
                });
                
                // algorithm Í∞í Î≥ÄÍ≤Ω Í∞êÏßÄ (Property descriptor Î∞©Ïãù)
                const algorithmDesc = Object.getOwnPropertyDescriptor(algorithmWidget, "value") || {};
                let algorithmValue = algorithmWidget.value;
                
                Object.defineProperty(algorithmWidget, "value", {
                    get() {
                        return algorithmDesc.get ? algorithmDesc.get.call(algorithmWidget) : algorithmValue;
                    },
                    set(newVal) {
                        console.log(`[Grid Search] üîÄ Algorithm changed from "${algorithmValue}" to "${newVal}"`);
                        
                        if (algorithmDesc.set) algorithmDesc.set.call(algorithmWidget, newVal);
                        else algorithmValue = newVal;
                        
                        // ÏúÑÏ†Ø Í∞ÄÏãúÏÑ± ÏóÖÎç∞Ïù¥Ìä∏
                        updateWidgetVisibility(advancedWidget.value, newVal);
                    }
                });
                
                // Ï¥àÍ∏∞ ÏÉÅÌÉú ÏÑ§Ï†ï
                console.log(`[Grid Search] üöÄ Setting initial state...`);
                updateWidgetVisibility(advancedWidget.value || false, algorithmWidget.value || "");
            };
            
            // ÎÖ∏Îìú Ï†úÍ±∞ Ïãú Ï†ïÎ¶¨
            const originalOnRemoved = nodeType.prototype.onRemoved;
            nodeType.prototype.onRemoved = function() {
                console.log(`[Grid Search] üóëÔ∏è Cleaning up node: ${this.nodeKey}`);
                
                // Ïù¥ ÎÖ∏ÎìúÏùò ÏõêÎ≥∏ ÏÜçÏÑ±Îì§ Ï†ïÎ¶¨
                if (this.nodeKey) {
                    Object.keys(origProps).forEach(key => {
                        if (key.startsWith(this.nodeKey)) {
                            delete origProps[key];
                        }
                    });
                }
                
                originalOnRemoved?.apply(this, arguments);
            };
        }
    }
});

console.log("üéØ QSAR Grid Search Advanced Extension Loaded (Fixed Version)");
